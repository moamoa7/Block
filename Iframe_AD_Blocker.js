// ==UserScript==
// @name         Iframe Logger & Blocker (ÏµúÏã† ÌÜµÌï©Ìåê for Violentmonkey)
// @namespace    none
// @version      7.0
// @description  iframe Ïã§ÏãúÍ∞Ñ ÌÉêÏßÄ+Ï∞®Îã®, srcdoc+data-* Î∂ÑÏÑù, ÌôîÏù¥Ìä∏Î¶¨Ïä§Ìä∏, ÏûêÏãù Î°úÍ∑∏ Î∂ÄÎ™® Ï†ÑÎã¨, Shadow DOM ÌÉêÏÉâ, Î°úÍ∑∏ UI, ÎìúÎûòÍ∑∏, ÏûêÎèô Ïà®ÍπÄ
// @match        *://*/*
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  const ENABLE_LOG_UI = true;
  const REMOVE_IFRAME = true;
  const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);

  const seen = new WeakSet();
  const pendingSrcMap = new WeakMap();
  let count = 0;
  let logList = [];
  let logContainer, logContent, countDisplay, hideTimeout;

  // Í∏ÄÎ°úÎ≤å ÌÇ§ÏõåÎìú ÌôîÏù¥Ìä∏Î¶¨Ïä§Ìä∏
  const globalWhitelistKeywords = [
    'recaptcha', 'cloudflare.com', 'player.bunny-frame.online', 'naver.com',
    '/embed/', '/e/', '/t/', 'dlrstream.com', '123123play.com', 'supremejav.com',
    'goodTubeProxy',
  ];

  // ÎèÑÎ©îÏù∏Î≥Ñ ÌÇ§ÏõåÎìú ÌôîÏù¥Ìä∏Î¶¨Ïä§Ìä∏
  const whitelistMap = {
    'supjav.com': ['supremejav.com'],
    'avsee.ru': ['player/'],
    '7tv000.com': [''],
    'cdnbuzz.buzz': [''],
    'blog.naver.com': [''],
    'cafe.naver.com': [''],
    'naver.com': ['my.html'],
  };

  function isWhitelisted(url = '') {
    try {
      // Í∏ÄÎ°úÎ≤å ÌÇ§ÏõåÎìú Ï≤¥ÌÅ¨
      for (const keyword of globalWhitelistKeywords) {
        if (url.includes(keyword)) return true;
      }
      // ÎèÑÎ©îÏù∏Î≥Ñ ÌÇ§ÏõåÎìú Ï≤¥ÌÅ¨
      const u = new URL(url, location.href);
      const domain = u.hostname;
      const path = u.pathname + u.search;
      for (const [host, keywords] of Object.entries(whitelistMap)) {
        if (domain.includes(host)) {
          if (keywords.length === 0 || keywords.some(k => path.includes(k))) {
            return true;
          }
        }
      }
    } catch {}
    return false;
  }

  // srcdocÏóêÏÑú src/href URL Ï∂îÏ∂ú
  function extractUrlsFromSrcdoc(srcdoc = '') {
    const urls = [];
    try {
      const temp = document.createElement('div');
      temp.innerHTML = srcdoc;
      const tags = temp.querySelectorAll('[src], [href]');
      tags.forEach(el => {
        const val = el.getAttribute('src') || el.getAttribute('href');
        if (val) urls.push(val);
      });
    } catch {}
    return urls;
  }

  // data-* ÏÜçÏÑ±ÏóêÏÑú URL Ï∂îÏ∂ú
  function extractUrlsFromDataset(el) {
    const urls = [];
    try {
      for (const key of Object.keys(el.dataset)) {
        const val = el.dataset[key];
        if (val && /^https?:\/\//.test(val)) {
          urls.push(val);
        }
      }
    } catch {}
    return urls;
  }

  // Shadow DOM Ìè¨Ìï® Î™®Îì† iframe/frame/embed/object ÏàòÏßë
  function getAllIframes(root = document) {
    let found = [];
    try {
      found = Array.from(root.querySelectorAll('iframe,frame,embed,object'));
    } catch {}
    const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT);
    while (walker.nextNode()) {
      const node = walker.currentNode;
      if (node.shadowRoot) {
        found = found.concat(getAllIframes(node.shadowRoot));
      }
    }
    return found;
  }

  // Î°úÍ∑∏ UI ÏÉùÏÑ± Î∞è ÎìúÎûòÍ∑∏ Í∏∞Îä•
  function createLogUI() {
    if (!ENABLE_LOG_UI || isMobile) return;

    // Î≤ÑÌäºÏùÑ Ï∂îÍ∞ÄÌïòÏó¨ Î°úÍ∑∏ Ìå®ÎÑêÏùÑ ÌÜ†Í∏Ä
    const btn = document.createElement('button');
    btn.textContent = 'üõ°Ô∏è'; btn.title = 'Iframe Î°úÍ∑∏ ÌÜ†Í∏Ä';
    btn.style.cssText = 'position:fixed;bottom:10px;right:10px;z-index:99999;width:40px;height:40px;border-radius:50%;border:none;background:#222;color:#fff;font-size:20px;cursor:pointer;';
    document.body.appendChild(btn);

    // Ìå®ÎÑê Ïä§ÌÉÄÏùº ÏÑ§Ï†ï
    const panel = document.createElement('div');
    panel.style.cssText = 'position:fixed;bottom:60px;right:10px;width:500px;max-height:400px;background:rgba(0,0,0,0.85);color:white;font-family:monospace;font-size:13px;border-radius:10px;box-shadow:0 0 10px black;display:none;flex-direction:column;overflow:hidden;z-index:99999;';

    const header = document.createElement('div');
    header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:#000;font-weight:bold;font-size:14px;';
    const title = document.createElement('span'); title.textContent = 'üõ°Ô∏è Iframe Log View';

    countDisplay = document.createElement('span');
    countDisplay.style.cssText = 'font-size:12px;color:#ccc;margin-left:6px;';
    countDisplay.textContent = '(0)';

    const copyBtn = document.createElement('button');
    copyBtn.textContent = 'üìã Î≥µÏÇ¨';
    copyBtn.style.cssText = 'font-size:12px;background:#444;color:white;border:none;border-radius:5px;padding:2px 8px;cursor:pointer;';
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(logList.join('\n')).then(() => {
        copyBtn.textContent = 'Î≥µÏÇ¨Îê®!';
        setTimeout(() => copyBtn.textContent = 'üìã Î≥µÏÇ¨', 1500);
      });
    };

    const left = document.createElement('div');
    left.appendChild(title);
    left.appendChild(countDisplay);
    header.appendChild(left);
    header.appendChild(copyBtn);

    // Î°úÍ∑∏ ÏΩòÌÖêÏ∏† ÏòÅÏó≠ ÏÑ§Ï†ï
    logContent = document.createElement('div');
    logContent.style.cssText = 'overflow-y:auto;flex:1;padding:6px 10px;white-space:pre-wrap;';
    panel.appendChild(header);
    panel.appendChild(logContent);
    document.body.appendChild(panel);

    // Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ìå®ÎÑêÏùÑ ÌÜ†Í∏Ä
    btn.onclick = () => panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
  }

  function showLogUI() {
    if (!logContainer) return;
    logContainer.style.display = 'flex';
    clearTimeout(hideTimeout);
    hideTimeout = setTimeout(() => {
      logContainer.style.display = 'none';
    }, 10000);
  }

  function updateCountDisplay() {
    if (countDisplay) countDisplay.textContent = `(${count})`;
  }

  // iframe Î°úÍ∑∏ Î∞è Ï∞®Îã® Ï≤òÎ¶¨
  function logIframe(iframe, reason = '', srcHint = '') {
    let src = srcHint || iframe?.src || iframe?.getAttribute('src') || '';
    const srcdoc = iframe?.srcdoc || iframe?.getAttribute('srcdoc') || '';
    const dataUrls = extractUrlsFromDataset(iframe);
    const extracted = extractUrlsFromSrcdoc(srcdoc);
    if (!src && extracted.length > 0) src = extracted[0];
    if (!src && dataUrls.length > 0) src = dataUrls[0];

    const outer = iframe?.outerHTML?.slice(0, 200).replace(/\s+/g, ' ') || '';
    const info = `[#${++count}] ${reason} ${src || '[No src]'}\n ‚îî‚ñ∂ HTML ‚Üí ${outer}`;
    console.warn('%c[Iframe Detected]', 'color: red; font-weight: bold;', info);

    // Ìï©Ïπú Î¨∏ÏûêÏó¥Î°ú ÌôîÏù¥Ìä∏Î¶¨Ïä§Ìä∏ Ï≤¥ÌÅ¨
    const combined = [src, ...dataUrls, ...extracted].join(' ');
    const isWhitelistedIframe = isWhitelisted(combined);

    // Î°úÍ∑∏ ÏÉâÏÉÅ ÏÑ§Ï†ï (ÎÖπÏÉâ: ÌôîÏù¥Ìä∏Î¶¨Ïä§Ìä∏, Îπ®Í∞ÑÏÉâ: Ï∞®Îã®Îê®)
    const logColor = isWhitelistedIframe ? 'green' : 'red';

    if (!isWhitelistedIframe && iframe && REMOVE_IFRAME) {
      iframe.style.display = 'none';
      iframe.setAttribute('sandbox', '');
      setTimeout(() => iframe.remove(), 500);
    }

    if (ENABLE_LOG_UI && !isMobile && logContent) {
      logList.push(info);
      const div = document.createElement('div');
      div.style.cssText = `color: ${logColor}; padding: 2px 0; white-space: pre-wrap;`;
      div.textContent = info;
      logContent.appendChild(div);
      if (logContent.children.length > 100) logContent.removeChild(logContent.children[0]);
      updateCountDisplay();
      showLogUI();
    }
  }

  // iframe Ï§ëÎ≥µ Î∞©ÏßÄ Î∞è ÏßÄÏó∞ src Ï≤òÎ¶¨
  function handleIframe(el, reason) {
    if (seen.has(el)) return;
    seen.add(el);
    if (!el.src && !el.getAttribute('src')) {
      pendingSrcMap.set(el, reason);
    } else {
      logIframe(el, reason);
    }
  }

  // ÏßÄÏó∞ srcÍ∞Ä ÏÉùÍ∏∞Îäî iframe Í∞êÏãú Î∞òÎ≥µ
  function monitorDeferredIframes() {
    pendingSrcMap.forEach((reason, el) => {
      if (el.src || el.getAttribute('src')) {
        logIframe(el, reason + ' (late src)');
        pendingSrcMap.delete(el);
      }
    });
    requestAnimationFrame(monitorDeferredIframes);
  }

  // Shadow DOM Ìè¨Ìï® Î™®Îì† iframe Ïä§Ï∫î
  function scanAll(reason = 'initialScan') {
    const iframes = getAllIframes();
    iframes.forEach(el => handleIframe(el, reason));
  }

  // ÏûêÏãù ÌîÑÎ†àÏûÑÏù¥Î©¥ Î∂ÄÎ™®Ïóê Î°úÍ∑∏ Î©îÏãúÏßÄ Ï†ÑÎã¨
  if (window.top !== window) {
    setTimeout(() => {
      window.parent.postMessage('[CHILD_IFRAME_LOG]' + location.href, '*');
    }, 100);
    return;
  }

  // Î∂ÄÎ™® ÌîÑÎ†àÏûÑÏóêÏÑú ÏûêÏãù ÌîÑÎ†àÏûÑ Î°úÍ∑∏ ÏàòÏã†
  window.addEventListener('message', (e) => {
    if (typeof e.data === 'string' && e.data.startsWith('[CHILD_IFRAME_LOG]')) {
      const url = e.data.slice(18);
      logIframe(null, 'from child', url);
    }
  });

  // createElement ÌõÑ iframe Ï∂îÏ†Å
  const originalCreate = Document.prototype.createElement;
  Document.prototype.createElement = function (...args) {
    const el = originalCreate.apply(this, args);
    if (["iframe", "frame", "embed", "object"].includes(String(args[0]).toLowerCase())) {
      setTimeout(() => handleIframe(el, 'createElement'), 10);
    }
    return el;
  };

  // appendChild ÌõÑ iframe Ï∂îÏ†Å
  const originalAppend = Node.prototype.appendChild;
  Node.prototype.appendChild = function (child) {
    const result = originalAppend.call(this, child);
    if (child instanceof HTMLElement && ['IFRAME', 'FRAME', 'OBJECT', 'EMBED'].includes(child.tagName)) {
      setTimeout(() => handleIframe(child, 'appendChild'), 10);
    }
    return result;
  };

  // setAttributeÎ°ú src Î≥ÄÍ≤ΩÏãú Ï∂îÏ†Å
  const originalSetAttr = Element.prototype.setAttribute;
  Element.prototype.setAttribute = function (name, value) {
    if (["src", "srcdoc", "data-src", "data-lazy-src", "data-href", "data-real-src"].includes(name.toLowerCase()) &&
        this.tagName && ['IFRAME', 'FRAME', 'EMBED', 'OBJECT'].includes(this.tagName)) {
      setTimeout(() => handleIframe(this, `setAttribute:${name}`), 10);
    }
    return originalSetAttr.apply(this, arguments);
  };

  // iframe.src ÏßÅÏ†ë Ìï†Îãπ Í∞êÏßÄ
  const originalSrc = Object.getOwnPropertyDescriptor(HTMLIFrameElement.prototype, 'src');
  if (originalSrc?.set) {
    Object.defineProperty(HTMLIFrameElement.prototype, 'src', {
      set(value) {
        setTimeout(() => handleIframe(this, 'src= (direct assign)'), 10);
        return originalSrc.set.call(this, value);
      },
      get: originalSrc.get,
      configurable: true,
      enumerable: true
    });
  }

  // MutationObserverÎ°ú ÏÉà iframe Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ
  const observer = new MutationObserver(mutations => {
    for (const m of mutations) {
      for (const node of m.addedNodes) {
        if (!(node instanceof HTMLElement)) continue;
        if (['IFRAME', 'FRAME', 'EMBED', 'OBJECT'].includes(node.tagName)) {
          handleIframe(node, 'MutationObserver add');
        }
        // ShadowRoot ÏïàÏùò iframeÎèÑ ÌÉêÏÉâ
        if (node.shadowRoot) {
          const nestedIframes = getAllIframes(node.shadowRoot);
          nestedIframes.forEach(f => handleIframe(f, 'MutationObserver shadowRoot'));
        }
      }
    }
  });
  observer.observe(document, { childList: true, subtree: true });

  // ÌéòÏù¥ÏßÄ Î°úÎìú ÌõÑ Ï†ÑÏ≤¥ Ïä§Ï∫î Î∞è ÏßÄÏó∞ src Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      if (ENABLE_LOG_UI) createLogUI();
      scanAll('initialScan');
      monitorDeferredIframes();
    });
  } else {
    if (ENABLE_LOG_UI) createLogUI();
    scanAll('initialScan');
    monitorDeferredIframes();
  }
})();
